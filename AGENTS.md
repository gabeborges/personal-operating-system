# AGENTS.md — Source of Truth (Global Rules + Swarm Collaboration)

This file is the **non-drifting source of truth** for how humans and agents work in this repo.
Tool-specific files (e.g., `CLAUDE.md`, Cursor rules) MUST NOT contradict this document.

Tech stack: Next.js (App Router, JS/React), Tailwind, shadcn/ui, Headless UI, Supabase, Vercel, Stripe, Google OAuth.
Testing: Vitest + Playwright. Package manager: npm.
Workflow: Spec-Driven Development (SDD) using Clavix + OpenSpec + an agent swarm.

---

## 1) SDD Canonical Artifacts & Paths (Authoritative)

Agents MUST use these artifacts in this priority order:

1. `.ops/build/product-vision-strategy.md`
   - High-level product context generated by Clavix.

2. `.ops/build/v{x}/prd.md`
   - Build/version scope and acceptance intent for the current version.

3. `.ops/build/v{x}/epic.md`
   - Version-level epic + high-level tasks generated by OpenSpec.

4. `.ops/build/v{x}/<feature-name>/spec.md`
   - Feature requirements + acceptance criteria (scenarios). **This is the acceptance source of truth**.

5. `.ops/build/v{x}/<feature-name>/tasks.md`
   - Feature tickets derived from `spec.md`.
   - Each ticket MUST include `implements:` pointers into `spec.md`.

6. `.ops/ui-design-system.md` (when UI exists)
   - Project-level UI design system + rules (generated/maintained via `interface-design` commands).
   - If present, it is the UI source of truth for layout, typography, spacing, components, and styling.

### Strict definitions (do not drift)
- `epic.md` = version-level plan in `.ops/build/v{x}/epic.md`
- `tasks.md` = feature-level tickets in `.ops/build/v{x}/<feature-name>/tasks.md`
- `spec.md` = feature requirements + acceptance criteria (replaces `acceptance.md`)
- `prd.md` = build-level plan (replaces `project.md`)

### Folder structure (Authoritative)
```
.ops/
└── build/
    ├── product-vision-strategy.md
    ├── ui-design-system.md (optional)
    └── v{x}/
        ├── prd.md
        ├── epic.md
        ├── proposal.md 
        ├── design.md 
        └── <feature-name>/
            ├── spec.md
            ├── tasks.md
            ├── decisions.md
            └── (optional) ui.md, security.md, compliance.md, db-migration-plan.md, etc.
```

---

## 2) Stop Conditions (Ask Before Proceeding)

STOP and ask (do not guess) if any of the following are true:
- The target build version `v{x}` is unclear.
- `spec.md` is missing, contradictory, or lacks scenarios that define acceptance.
- `tasks.md` is missing or any ticket lacks a valid `implements:` pointer into `spec.md`.
- Implementation would require changing requirements or acceptance criteria.
- A security/compliance risk exists (PHI/PII exposure, weakened auth, RLS bypass, logging sensitive data).
- Stripe / OAuth / Supabase settings are required but not specified.

If implementation constraints conflict with the spec:
- Create `.ops/build/v{x}/<feature-name>/spec-change-requests.md` describing the mismatch (brief, factual)
- Stop and escalate to the orchestrator/user.

---

## 3) Coding Standards (Enforced)

### 3.1 Linting & Formatting
- ESLint is required and MUST follow `next/core-web-vitals`.
- Prettier is required. Formatting is enforced in CI.
- Do not disable lint rules or introduce ignores unless explicitly required by tasks/spec and documented in `decisions.md`.

### 3.2 Naming Conventions (Non-negotiable)
- React components: **PascalCase**.
- Files and folders: **kebab-case** (unless Next.js requires otherwise for routing).
- APIs/routes: follow REST + Next.js conventions (App Router route handlers, standard HTTP semantics).

### 3.3 Minimal-change discipline
- Prefer the smallest diff that satisfies the ticket.
- No unrelated refactors, renames, or formatting-only churn.
- If a shared module is touched, add/adjust tests proportional to risk.

---

## 4) Architecture Rules & Boundaries (Hard Rules)

### 4.1 Feature isolation
- **No cross-feature imports.**
  - Features must not import each other’s internals.
  - Shared code must live in clearly shared locations (e.g., `lib/`, `components/`, `utils/`) per repo conventions.

### 4.2 Data access boundary (Supabase)
- **UI must not call Supabase directly.**
- Use **Supabase Edge Functions** (or server-side boundaries) for data access.
- Supabase **RLS is non-negotiable**. Never bypass it.

### 4.3 Next.js App Router constraints
- App Router is authoritative (`app/`).
- Server Actions:
  - **Only for mutations**.
  - Keep reads server-side via route handlers/edge functions as per feature design.

### 4.4 Stripe boundary (Hard rules)
- Shared config:
  - `/lib/stripe.js` for server/client configuration.
- Backend checkout handling:
  - `/app/api/checkout/route.js`
- Frontend components use:
  - `@stripe/react-stripe-js`
- Do not alter billing semantics, price IDs, webhook handling, or scopes without explicit spec/tasks.

---

## 5) Security & Compliance Defaults (PHI/Health Data)

This repo handles PHI/health data. Default posture is “assume sensitive”.

### 5.1 Secrets & credentials
- Never commit `.env*` files or any credential files.
- Never hardcode secrets/tokens/keys.
- Never print or log secrets.

### 5.2 Logging rules (PHI/PII safe-by-default)
- Do not log PHI/PII payloads.
- When debugging, log only:
  - request IDs, timestamps, non-sensitive error codes, coarse metadata
- Scrub/omit:
  - names, emails, phone numbers, addresses, notes, messages, session contents, tokens

### 5.3 Authorization & data access
- Never weaken auth checks or permission gates.
- Never move privileged logic to the client.
- Supabase RLS must be respected in design and implementation.

If compliance/security requirements require spec changes:
- Use `spec-change-requests.md` and stop.

---

## 6) Definition of Done (DoD)

A ticket is “done” ONLY when all are true:
- ✅ Tests pass locally (Vitest + Playwright as applicable)
- ✅ Tests added/updated for new behavior (proportional to risk)
- ✅ All relevant `spec.md` scenarios are satisfied
- ✅ Code reviewed (peer/agent reviewer per workflow)

When finishing work, report:
- What changed (files/modules)
- Which `spec.md` requirements/scenarios were satisfied (via `implements:` pointers)
- What validation was performed (commands run + outcomes)

---

# SDD Subagent Index (Swarm Collaboration)

This section regulates agent collaboration: roster, tiers, and when to invoke whom.

## Quick Reference

| Agent | Role | Category | File |
|-------|------|----------|------|
| Workflow Orchestrator | Orchestration + routing | orchestration | [.claude/agents/workflow-orchestrator.md](.claude/agents/workflow-orchestrator.md) |
| Context Manager | Memory + decision log | orchestration | [.claude/agents/context-manager.md](.claude/agents/context-manager.md) |
| Project Task Planner | Spec handoff / ticket writer | planning | [.claude/agents/project-task-planner.md](.claude/agents/project-task-planner.md) |
| UI Designer | UX intent + flows | design | [.claude/agents/ui-designer.md](.claude/agents/ui-designer.md) |
| Frontend Designer | Design→implementation translator | design | [.claude/agents/frontend-designer.md](.claude/agents/frontend-designer.md) |
| Fullstack Developer | Primary builder | implementation | [.claude/agents/fullstack-developer.md](.claude/agents/fullstack-developer.md) |
| Database Administrator | Migration strategist / safety gate | implementation | [.claude/agents/database-administrator.md](.claude/agents/database-administrator.md) |
| QA | Contract validation + exploratory | quality | [.claude/agents/qa.md](.claude/agents/qa.md) |
| Test Automator | Automated test implementer | quality | [.claude/agents/test-automator.md](.claude/agents/test-automator.md) |
| Debugger | Root-cause investigator | quality | [.claude/agents/debugger.md](.claude/agents/debugger.md) |
| Code Reviewer | Quality gate | quality | [.claude/agents/code-reviewer.md](.claude/agents/code-reviewer.md) |
| Security Engineer | Secure-by-design implementer | security | [.claude/agents/security-engineer.md](.claude/agents/security-engineer.md) |
| Security Auditor | Independent security reviewer | security | [.claude/agents/security-auditor.md](.claude/agents/security-auditor.md) |
| Compliance Engineer | Compliance-by-design | compliance | [.claude/agents/compliance-engineer.md](.claude/agents/compliance-engineer.md) |
| Compliance Auditor | Compliance reviewer | compliance | [.claude/agents/compliance-auditor.md](.claude/agents/compliance-auditor.md) |

## By Category

### Orchestration
- **Workflow Orchestrator** — Enforces SDD sequence, triggers agents, routes spec breaks
- **Context Manager** — Append-only decision log, resumable state

### Planning
- **Project Task Planner** — Parses OpenSpec into feature `tasks.md` with `implements:` pointers into feature `spec.md`

### Design
- **UI Designer** — UX flows, screens, states, accessibility
- **Frontend Designer** — Component breakdown (props/states) from `ui.md`

### Implementation
- **Fullstack Developer** — Primary code writer, implements feature `tasks.md` with tests
- **Database Administrator** — DB Change Guardian, expand/contract migration plans

### Quality
- **QA** — Contract validation against `spec.md` scenarios
- **Test Automator** — Converts `spec.md` scenarios into automated tests
- **Debugger** — Root-cause analysis, produces fix tickets
- **Code Reviewer** — PR quality gate, spec compliance verification

### Security
- **Security Engineer** — Defines secure-by-design patterns in `security.md`
- **Security Auditor** — Independent security review, OWASP checks

### Compliance
- **Compliance Engineer** — Translates compliance needs into technical requirements
- **Compliance Auditor** — Independent compliance verification

## Dependency DAG

```
Tier 1: workflow-orchestrator, context-manager
   ↓
Tier 2: project-task-planner
   ↓
Tier 3: ui-designer, security-engineer, compliance-engineer
   ↓
Tier 4: frontend-designer, database-administrator
   ↓
Tier 5: fullstack-developer, test-automator
   ↓
Tier 6: qa, debugger, code-reviewer, security-auditor, compliance-auditor
```



## Agent Selection Guide

| Situation | Agent to invoke |
|-----------|-----------------|
| Starting a new feature | workflow-orchestrator |
| Spec is ready, need feature tasks | project-task-planner |
| Feature has UI | ui-designer → frontend-designer |
| Feature has DB changes | database-administrator |
| Ready to implement | fullstack-developer |
| Implementation done, need validation | qa + test-automator |
| Tests failing | debugger |
| PR ready for review | code-reviewer |
| Security-sensitive feature | security-engineer → security-auditor |
| Compliance-sensitive feature | compliance-engineer → compliance-auditor |
| Need to record a decision | context-manager |
| Spec can't be implemented as-is | workflow-orchestrator (creates spec-change-request) |


**UI system rule:**
- Before any UI work, check for `.ops/ui-design-system.md`.
- If missing, run `/interface-design:init` (or have the orchestrator do it).
- If present, `ui-designer` and `frontend-designer` MUST follow it.
- Use `frontend-design` skill for simple one-off pages/components when no system updates are needed.
## Swarm Orchestration

Use `/orchestrate <feature-path>` to run the full SDD build phase automatically.

Feature workspace path convention:
- `.ops/build/v{x}/<feature-name>/` (aka `{feature-path}`)

The workflow-orchestrator spawns agents tier-by-tier and auto-detects which optional agents are needed from `tasks.md` / `spec.md` content.
See [.claude/agents/swarm-config.md](.claude/agents/swarm-config.md) for the agent↔teammate mapping and keyword triggers.

## Supporting References

- Agent roles, inputs, outputs: [.claude/agents/instructions.md](.claude/agents/instructions.md)
- Agent template format: [agentsmd/agents.md](https://github.com/agentsmd/agents.md)
- Swarm orchestration config: [.claude/agents/swarm-config.md](.claude/agents/swarm-config.md)
